<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Marketplace</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#0d0d12;color:#ddd;font-size:13px}
        header{background:#141419;padding:12px 20px;border-bottom:1px solid #c9a227;display:flex;align-items:center;justify-content:space-between}
        .logo{color:#c9a227;font-weight:700;font-size:18px;letter-spacing:1px;display:flex;align-items:center;gap:10px}
        .logo-icon{width:32px;height:32px;border-radius:4px;object-fit:cover}
        nav{display:flex;gap:20px;align-items:center}
        nav a{color:#888;text-decoration:none;font-size:12px}
        nav a:hover{color:#c9a227}
        .status{font-size:10px;padding:4px 10px;border-radius:10px}
        .status.on{background:#143d1f;color:#4a8}
        .status.off{background:#3d1414;color:#c44}
        
        .search-bar{background:#141419;padding:15px 20px;border-bottom:1px solid #252530;display:flex;gap:10px;align-items:center}
        .search-bar input{flex:1;padding:10px 15px;background:#1a1a22;border:1px solid #2a2a35;border-radius:4px;color:#ddd;font-size:13px}
        .search-bar input:focus{outline:none;border-color:#c9a227}
        .search-bar button{padding:10px 20px;background:#c9a227;border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer}
        .search-bar button:hover{background:#d4af37}
        
        .stats{display:flex;justify-content:center;gap:40px;padding:15px;background:#1a1a22;border-bottom:1px solid #252530}
        .stat-item{text-align:center}
        .stat-value{font-size:18px;font-weight:700;color:#c9a227}
        .stat-label{font-size:10px;color:#666;text-transform:uppercase}
        
        main{display:flex;min-height:calc(100vh - 180px)}
        
        .sidebar{width:200px;background:#141419;padding:15px;border-right:1px solid #252530}
        .filter-group{margin-bottom:20px}
        .filter-title{font-size:10px;color:#666;text-transform:uppercase;margin-bottom:8px;font-weight:600}
        .filter-group select{width:100%;padding:8px;background:#1a1a22;border:1px solid #2a2a35;color:#ddd;border-radius:3px;font-size:11px}
        .filter-group label{display:block;padding:4px 0;font-size:11px;cursor:pointer}
        .filter-group input[type=checkbox]{margin-right:6px;accent-color:#c9a227}
        .price-inputs{display:flex;gap:5px}
        .price-inputs input{width:50%;padding:6px;background:#1a1a22;border:1px solid #2a2a35;color:#ddd;border-radius:3px;font-size:11px}
        .clear-btn{width:100%;padding:8px;background:transparent;border:1px solid #2a2a35;color:#888;border-radius:3px;cursor:pointer;font-size:11px;margin-top:10px}
        .clear-btn:hover{border-color:#c9a227;color:#c9a227}
        
        .content{flex:1;padding:20px}
        .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .results-count{font-size:12px;color:#888}
        .results-count b{color:#c9a227}
        .sort-select{padding:6px 10px;background:#1a1a22;border:1px solid #2a2a35;color:#ddd;border-radius:3px;font-size:11px}
        
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px}
        .card{background:#1a1a22;border:1px solid #252530;border-radius:6px;overflow:hidden;cursor:pointer;transition:all .2s}
        .card:hover{border-color:#c9a227;transform:translateY(-2px)}
        .card img{width:100%;aspect-ratio:0.72;object-fit:cover;background:#141419}
        .card-body{padding:12px}
        .card-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
        .card-set{font-size:10px;color:#666;margin-bottom:8px}
        .card-footer{display:flex;justify-content:space-between;align-items:center}
        .card-price{font-size:16px;font-weight:700;color:#c9a227}
        .card-rarity{font-size:9px;padding:2px 6px;border-radius:3px;text-transform:uppercase}
        .card-rarity.mythic{background:#8b4513;color:#ffa500}
        .card-rarity.rare{background:#1a1a4a;color:#ffd700}
        .card-rarity.uncommon{background:#1a3a1a;color:#c0c0c0}
        .card-rarity.common{background:#2a2a2a;color:#888}
        
        .pagination{display:flex;justify-content:center;gap:5px;margin-top:20px}
        .pagination button{padding:8px 12px;background:#1a1a22;border:1px solid #252530;color:#ddd;border-radius:3px;cursor:pointer;font-size:11px}
        .pagination button:hover{border-color:#c9a227}
        .pagination button.active{background:#c9a227;color:#000;border-color:#c9a227}
        .pagination button:disabled{opacity:.3;cursor:not-allowed}
        
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center}
        .modal.show{display:flex}
        .modal-content{background:#141419;border:1px solid #252530;border-radius:8px;max-width:800px;width:95%;max-height:90vh;overflow:auto;display:flex}
        .modal-img{width:300px;flex-shrink:0;background:#0d0d12;display:flex;align-items:center;justify-content:center;padding:20px}
        .modal-img img{max-width:100%;max-height:400px;border-radius:8px}
        .modal-info{flex:1;padding:25px}
        .modal-name{font-size:22px;font-weight:700;margin-bottom:5px}
        .modal-set{font-size:13px;color:#666;margin-bottom:20px}
        .modal-price{font-size:32px;font-weight:700;color:#c9a227;margin-bottom:20px}
        .modal-details{font-size:12px;color:#888;line-height:1.8}
        .modal-details b{color:#ddd}
        .modal-close{position:absolute;top:15px;right:20px;background:none;border:none;color:#666;font-size:28px;cursor:pointer}
        .modal-close:hover{color:#ddd}
        .modal-actions{margin-top:20px;display:flex;gap:10px}
        .modal-actions button{padding:12px 25px;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px}
        .btn-primary{background:#c9a227;border:none;color:#000}
        .btn-secondary{background:transparent;border:1px solid #2a2a35;color:#ddd}
        
        .loading{text-align:center;padding:60px;color:#666}
        .spinner{width:30px;height:30px;border:3px solid #252530;border-top-color:#c9a227;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .error{background:rgba(200,60,60,.1);border:1px solid #c44;padding:20px;border-radius:6px;color:#c44;text-align:center}
        .empty{text-align:center;padding:60px;color:#666}
        .empty-icon{font-size:48px;margin-bottom:15px}
        
        @media(max-width:768px){
            .sidebar{display:none}
            .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
            .modal-content{flex-direction:column}
            .modal-img{width:100%;height:200px}
        }
        
        /* Cart Panel */
        .cart-btn{color:#c9a227 !important;font-weight:600}
        .cart-panel{position:fixed;top:0;right:-450px;width:450px;height:100vh;background:#141419;border-left:2px solid #c9a227;z-index:1001;transition:right 0.3s;display:flex;flex-direction:column}
        .cart-panel.open{right:0}
        .cart-header{padding:20px;border-bottom:1px solid #252530;display:flex;justify-content:space-between;align-items:center}
        .cart-title{font-size:18px;font-weight:700;color:#c9a227}
        .cart-close{background:none;border:none;color:#888;font-size:24px;cursor:pointer}
        .cart-body{flex:1;overflow-y:auto;padding:15px}
        .cart-item{display:flex;gap:12px;padding:15px;background:#1a1a22;border-radius:6px;margin-bottom:10px}
        .cart-item-img{width:60px;height:84px;object-fit:cover;border-radius:4px}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:13px;margin-bottom:4px}
        .cart-item-set{font-size:10px;color:#666;margin-bottom:4px}
        .cart-item-seller{font-size:10px;color:#888;margin-bottom:8px}
        .cart-item-price{color:#c9a227;font-weight:700}
        .cart-item-remove{background:none;border:none;color:#c44;font-size:11px;cursor:pointer;padding:4px 8px}
        .cart-item-remove:hover{text-decoration:underline}
        .cart-footer{padding:20px;border-top:1px solid #252530}
        .cart-total{display:flex;justify-content:space-between;font-size:18px;font-weight:700;margin-bottom:15px}
        .cart-total-value{color:#c9a227}
        .checkout-btn{width:100%;padding:15px;background:#c9a227;border:none;border-radius:6px;color:#000;font-weight:700;font-size:14px;cursor:pointer}
        .checkout-btn:hover{background:#d4af37}
        .checkout-btn:disabled{background:#444;color:#888;cursor:not-allowed}
        .cart-empty{text-align:center;padding:40px;color:#666}
        .cart-empty-icon{font-size:48px;margin-bottom:15px}
        .cart-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000}
        .cart-overlay.open{display:block}
        
        /* Checkout Modal */
        .checkout-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:1002;align-items:center;justify-content:center}
        .checkout-modal.show{display:flex}
        .checkout-content{background:#141419;border:1px solid #c9a227;border-radius:8px;width:500px;max-width:95%;padding:30px}
        .checkout-title{font-size:20px;font-weight:700;color:#c9a227;margin-bottom:20px}
        .checkout-form input,.checkout-form textarea{width:100%;padding:12px;background:#1a1a22;border:1px solid #2a2a35;color:#ddd;border-radius:4px;margin-bottom:15px;font-size:13px}
        .checkout-form input:focus,.checkout-form textarea:focus{border-color:#c9a227;outline:none}
        .checkout-form label{font-size:11px;color:#888;display:block;margin-bottom:5px}
        .checkout-btns{display:flex;gap:10px;margin-top:10px}
        .checkout-btns button{flex:1;padding:12px;border-radius:4px;font-weight:600;cursor:pointer}
        
        /* Dev Chat */
        .dev-chat{position:fixed;bottom:0;right:20px;width:400px;background:#141419;border:2px solid #c9a227;border-bottom:none;border-radius:8px 8px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,0.5);z-index:999;transition:height 0.3s}
        .dev-chat.collapsed{height:45px}
        .dev-chat:not(.collapsed){height:500px}
        .dev-chat-header{background:#1a1a22;padding:12px 15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2a2a35}
        .dev-chat-title{font-weight:700;font-size:13px;color:#c9a227;display:flex;align-items:center;gap:8px}
        .dot{width:8px;height:8px;border-radius:50%;background:#4a8;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .dev-chat-toggle{background:none;border:none;color:#888;font-size:16px;cursor:pointer;transition:transform 0.3s}
        .dev-chat:not(.collapsed) .dev-chat-toggle{transform:rotate(180deg)}
        .dev-chat-body{height:calc(100% - 100px);overflow-y:auto;padding:15px;background:#0d0d12}
        .chat-msg{margin-bottom:12px}
        .chat-author{font-weight:700;font-size:11px;margin-bottom:4px}
        .chat-author.kevin{color:#ffd700}
        .chat-author.jacques{color:#58a6ff}
        .chat-author.mendel{color:#f85149}
        .chat-author.clouse{color:#a371f7}
        .chat-text{font-size:12px;line-height:1.5;color:#ddd;padding-left:8px}
        .chat-input-area{display:flex;gap:8px;padding:12px;background:#1a1a22;border-top:1px solid #2a2a35}
        .chat-input-area input{flex:1;padding:10px;background:#0d0d12;border:1px solid #2a2a35;color:#ddd;border-radius:4px;font-size:12px}
        .chat-input-area button{padding:10px 20px;background:#c9a227;border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer}
        .chat-input-area button:hover{background:#d4af37}
    </style>
</head>
<body>

<header>
    <div class="logo"><img src="/brand_icon.jpg" alt="NEXUS" class="logo-icon">NEXUS MARKETPLACE</div>
    <nav>
        <a href="#browse">Browse</a>
        <a href="#sell">Sell Cards</a>
        <a onclick="toggleCart()" style="cursor:pointer" class="cart-btn">üõí Cart (<span id="cartCount">0</span>)</a>
        <a onclick="toggleChat()" style="cursor:pointer">Dev Chat üéØü§ñüåê</a>
        <span class="status off" id="serverStatus">‚óè Offline</span>
    </nav>
</header>

<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search cards by name..." onkeyup="if(event.key==='Enter')searchCards()">
    <button onclick="searchCards()">Search</button>
</div>

<div class="stats">
    <div class="stat-item">
        <div class="stat-value" id="totalCards">--</div>
        <div class="stat-label">Cards Listed</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="totalValue">--</div>
        <div class="stat-label">Total Value</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="uniqueSets">--</div>
        <div class="stat-label">Sets</div>
    </div>
</div>

<main>
    <aside class="sidebar">
        <div class="filter-group">
            <div class="filter-title">Price Range</div>
            <div class="price-inputs">
                <input type="number" id="priceMin" placeholder="Min">
                <input type="number" id="priceMax" placeholder="Max">
            </div>
        </div>
        <div class="filter-group">
            <div class="filter-title">Rarity</div>
            <label><input type="checkbox" value="mythic" onchange="applyFilters()"> Mythic Rare</label>
            <label><input type="checkbox" value="rare" onchange="applyFilters()"> Rare</label>
            <label><input type="checkbox" value="uncommon" onchange="applyFilters()"> Uncommon</label>
            <label><input type="checkbox" value="common" onchange="applyFilters()"> Common</label>
        </div>
        <div class="filter-group">
            <div class="filter-title">Color</div>
            <label><input type="checkbox" value="W" onchange="applyFilters()"> White</label>
            <label><input type="checkbox" value="U" onchange="applyFilters()"> Blue</label>
            <label><input type="checkbox" value="B" onchange="applyFilters()"> Black</label>
            <label><input type="checkbox" value="R" onchange="applyFilters()"> Red</label>
            <label><input type="checkbox" value="G" onchange="applyFilters()"> Green</label>
        </div>
        <button class="clear-btn" onclick="clearFilters()">Clear All Filters</button>
    </aside>
    
    <div class="content">
        <div class="results-header">
            <span class="results-count">Showing <b id="showCount">0</b> of <b id="totalCount">0</b> cards</span>
            <select class="sort-select" id="sortSelect" onchange="applyFilters()">
                <option value="name_asc">Name A-Z</option>
                <option value="name_desc">Name Z-A</option>
                <option value="price_desc">Price: High to Low</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="set">Set Name</option>
            </select>
        </div>
        <div id="cardGrid" class="grid"></div>
        <div id="pagination" class="pagination"></div>
    </div>
</main>

<div class="modal" id="cardModal" onclick="if(event.target===this)closeModal()">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-img"><img id="modalImg" src=""></div>
        <div class="modal-info">
            <div class="modal-name" id="modalName"></div>
            <div class="modal-set" id="modalSet"></div>
            <div class="modal-price" id="modalPrice"></div>
            <div class="modal-details" id="modalDetails"></div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="addCurrentToCart()">Add to Cart</button>
                <button class="btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-panel" id="cartPanel">
    <div class="cart-header">
        <div class="cart-title">üõí Shopping Cart</div>
        <button class="cart-close" onclick="toggleCart()">√ó</button>
    </div>
    <div class="cart-body" id="cartBody">
        <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            Cart is empty
        </div>
    </div>
    <div class="cart-footer">
        <div class="cart-total">
            <span>Total:</span>
            <span class="cart-total-value" id="cartTotal">$0.00</span>
        </div>
        <button class="checkout-btn" id="checkoutBtn" onclick="openCheckout()" disabled>Proceed to Checkout</button>
    </div>
</div>

<div class="checkout-modal" id="checkoutModal" onclick="if(event.target===this)closeCheckout()">
    <div class="checkout-content">
        <div class="checkout-title">Complete Your Order</div>
        <form class="checkout-form" id="checkoutForm" onsubmit="submitOrder(event)">
            <label>Full Name *</label>
            <input type="text" name="name" required placeholder="John Smith">
            <label>Email Address *</label>
            <input type="email" name="email" required placeholder="john@example.com">
            <label>Shipping Address</label>
            <textarea name="shipping_address" rows="3" placeholder="123 Main St&#10;City, State 12345"></textarea>
            <div class="checkout-btns">
                <button type="button" class="btn-secondary" onclick="closeCheckout()">Cancel</button>
                <button type="submit" class="btn-primary">Place Order</button>
            </div>
        </form>
        <p style="font-size:10px;color:#666;margin-top:15px;text-align:center">Seller will contact you with payment details after order placement.</p>
    </div>
</div>

<script>
const API = 'https://nexus-marketplace-1.onrender.com';
let allCards = [];
let filteredCards = [];
let page = 1;
const perPage = 48;

async function init() {
    await checkServer();
    await loadCards();
    await loadCart();
}

// ============================================
// CART MANAGEMENT
// ============================================

let cartItems = [];

async function loadCart() {
    try {
        const r = await fetch(API + '/api/cart', {credentials: 'include'});
        const data = await r.json();
        cartItems = data.items || [];
        renderCart();
    } catch(e) {
        console.error('Cart load error:', e);
    }
}

function renderCart() {
    const body = document.getElementById('cartBody');
    const countEl = document.getElementById('cartCount');
    const totalEl = document.getElementById('cartTotal');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    countEl.textContent = cartItems.length;
    
    if (!cartItems.length) {
        body.innerHTML = '<div class="cart-empty"><div class="cart-empty-icon">üõí</div>Cart is empty<br><small style="color:#555;margin-top:10px;display:block">Browse cards and add them to your cart</small></div>';
        totalEl.textContent = '$0.00';
        checkoutBtn.disabled = true;
        return;
    }
    
    let total = 0;
    body.innerHTML = cartItems.map(item => {
        total += item.subtotal || (item.price * item.quantity);
        return `
            <div class="cart-item">
                <img class="cart-item-img" src="${item.image_url || ''}" onerror="this.style.background='#1a1a22';this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 84%22><rect fill=%22%23141419%22 width=%2260%22 height=%2284%22/></svg>'">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.card_name || 'Unknown Card'}</div>
                    <div class="cart-item-set">${item.set_code || ''} ‚Ä¢ ${item.condition || 'NM'}</div>
                    <div class="cart-item-seller">Sold by: ${item.seller_name || 'NEXUS'}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <span class="cart-item-price">$${(item.price || 0).toFixed(2)}</span>
                        <button class="cart-item-remove" onclick="removeFromCart('${item.listing_id}')">Remove</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    totalEl.textContent = '$' + total.toFixed(2);
    checkoutBtn.disabled = false;
}

function toggleCart() {
    document.getElementById('cartPanel').classList.toggle('open');
    document.getElementById('cartOverlay').classList.toggle('open');
}

async function addToCart(listingId) {
    try {
        const r = await fetch(API + '/api/cart/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({listing_id: listingId, quantity: 1})
        });
        const data = await r.json();
        
        if (data.success) {
            await loadCart();
            // Quick feedback
            const countEl = document.getElementById('cartCount');
            countEl.style.transform = 'scale(1.5)';
            setTimeout(() => countEl.style.transform = 'scale(1)', 200);
            closeModal();
        } else {
            alert(data.error || 'Failed to add to cart');
        }
    } catch(e) {
        console.error('Add to cart error:', e);
        alert('Failed to add to cart');
    }
}

async function removeFromCart(listingId) {
    try {
        await fetch(API + '/api/cart/remove', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({listing_id: listingId})
        });
        await loadCart();
    } catch(e) {
        console.error('Remove error:', e);
    }
}

function openCheckout() {
    if (!cartItems.length) return;
    document.getElementById('checkoutModal').classList.add('show');
}

function closeCheckout() {
    document.getElementById('checkoutModal').classList.remove('show');
}

async function submitOrder(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value,
        email: form.email.value,
        shipping_address: form.shipping_address.value
    };
    
    try {
        const r = await fetch(API + '/api/checkout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(data)
        });
        const result = await r.json();
        
        if (result.success) {
            closeCheckout();
            toggleCart();
            cartItems = [];
            renderCart();
            alert('üéâ Order placed!\n\nOrder ID: ' + result.order_ids.join(', ') + '\n\nThe seller will contact you at ' + data.email + ' with payment details.');
        } else {
            alert(result.error || 'Checkout failed');
        }
    } catch(e) {
        console.error('Checkout error:', e);
        alert('Checkout failed - please try again');
    }
}

async function checkServer() {
    const el = document.getElementById('serverStatus');
    try {
        const r = await fetch(API + '/health');
        if (r.ok) {
            el.className = 'status on';
            el.textContent = '‚óè Online';
            
            const stats = await (await fetch(API + '/status')).json();
            document.getElementById('totalCards').textContent = (stats.cards_in_db || 0).toLocaleString();
            
            const analytics = await (await fetch(API + '/analytics/summary')).json();
            document.getElementById('totalValue').textContent = '$' + (analytics.total_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
        }
    } catch(e) {
        el.className = 'status off';
        el.textContent = '‚óè Offline';
    }
}

async function loadCards() {
    const grid = document.getElementById('cardGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading cards...</div>';
    
    try {
        const r = await fetch(API + '/api/listings?limit=1000');
        const data = await r.json();
        allCards = data.listings || data.cards || data.results || [];
        
        // Normalize card data structure
        allCards = allCards.map(c => ({
            ...c,
            name: c.card_name || c.name,
            set: c.set_code || c.set,
            image_url: c.image_url || (c.image_uris && c.image_uris.normal) || ''
        }));
        
        console.log('‚úÖ Loaded listings:', allCards.length);
        if (allCards.length > 0) {
            console.log('Sample listing:', allCards[0]);
        } else {
            console.log('‚ÑπÔ∏è No listings yet - marketplace is empty');
        }
        
        // Count unique sets
        const sets = new Set(allCards.map(c => c.set_name || c.set).filter(Boolean));
        document.getElementById('uniqueSets').textContent = sets.size;
        
        applyFilters();
    } catch(e) {
        console.error('‚ùå Load error:', e);
        grid.innerHTML = '<div class="error"><b>Cannot connect to server</b><br><br>Make sure server is running</div>';
    }
}

function searchCards() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (!q) {
        filteredCards = [...allCards];
    } else {
        filteredCards = allCards.filter(c => (c.name || '').toLowerCase().includes(q));
    }
    page = 1;
    renderCards();
}

function applyFilters() {
    let cards = [...allCards];
    
    // Search
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (q) cards = cards.filter(c => (c.name || '').toLowerCase().includes(q));
    
    // Price
    const minP = parseFloat(document.getElementById('priceMin').value) || 0;
    const maxP = parseFloat(document.getElementById('priceMax').value) || 999999;
    cards = cards.filter(c => {
        const p = parseFloat(c.price) || 0;
        return p >= minP && p <= maxP;
    });
    
    // Rarity
    const rarities = [...document.querySelectorAll('.filter-group input[value="mythic"], .filter-group input[value="rare"], .filter-group input[value="uncommon"], .filter-group input[value="common"]')]
        .filter(c => c.checked).map(c => c.value);
    if (rarities.length) cards = cards.filter(c => rarities.includes((c.rarity || '').toLowerCase()));
    
    // Color
    const colors = [...document.querySelectorAll('.filter-group input[value="W"], .filter-group input[value="U"], .filter-group input[value="B"], .filter-group input[value="R"], .filter-group input[value="G"]')]
        .filter(c => c.checked).map(c => c.value);
    if (colors.length) cards = cards.filter(c => {
        const cardColors = c.colors || c.color_identity || [];
        return colors.some(col => cardColors.includes(col));
    });
    
    // Sort
    const sort = document.getElementById('sortSelect').value;
    cards.sort((a, b) => {
        switch(sort) {
            case 'name_asc': return (a.name || '').localeCompare(b.name || '');
            case 'name_desc': return (b.name || '').localeCompare(a.name || '');
            case 'price_desc': return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
            case 'price_asc': return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
            case 'set': return (a.set_name || a.set || '').localeCompare(b.set_name || b.set || '');
            default: return 0;
        }
    });
    
    filteredCards = cards;
    page = 1;
    renderCards();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('priceMin').value = '';
    document.getElementById('priceMax').value = '';
    document.getElementById('sortSelect').value = 'name_asc';
    document.querySelectorAll('.sidebar input[type=checkbox]').forEach(c => c.checked = false);
    filteredCards = [...allCards];
    page = 1;
    renderCards();
}

function renderCards() {
    const grid = document.getElementById('cardGrid');
    const total = filteredCards.length;
    const start = (page - 1) * perPage;
    const pageCards = filteredCards.slice(start, start + perPage);
    
    document.getElementById('showCount').textContent = pageCards.length;
    document.getElementById('totalCount').textContent = total;
    
    if (!pageCards.length) {
        grid.innerHTML = '<div class="empty"><div class="empty-icon">üÉè</div>No cards found</div>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }
    
    grid.innerHTML = pageCards.map((c, i) => `
        <div class="card" onclick="openModal(${start + i})">
            ${c.image_url || (c.image_uris && c.image_uris.normal) ? 
                `<img src="${c.image_url || c.image_uris.normal}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%23141419%22 width=%22100%22 height=%22140%22/><text x=%2250%22 y=%2270%22 text-anchor=%22middle%22 fill=%22%23444%22 font-size=%228%22>No Image</text></svg>'">` :
                `<div style="width:100%;aspect-ratio:.72;background:#141419;display:flex;align-items:center;justify-content:center;color:#444;font-size:10px">No Image</div>`
            }
            <div class="card-body">
                <div class="card-name" title="${c.name || 'Unknown'}">${c.name || 'Unknown'}</div>
                <div class="card-set">${c.set_name || c.set || 'Unknown Set'}</div>
                <div class="card-footer">
                    <div class="card-price">${c.price ? '$' + parseFloat(c.price).toFixed(2) : '--'}</div>
                    <span class="card-rarity ${(c.rarity || '').toLowerCase()}">${c.rarity || ''}</span>
                </div>
            </div>
        </div>
    `).join('');
    
    renderPagination(total);
}

function renderPagination(total) {
    const pages = Math.ceil(total / perPage);
    if (pages <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
    }
    
    let html = `<button ${page === 1 ? 'disabled' : ''} onclick="goPage(${page - 1})">‚Üê Prev</button>`;
    
    for (let i = Math.max(1, page - 2); i <= Math.min(pages, page + 2); i++) {
        html += `<button class="${i === page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
    }
    
    html += `<button ${page === pages ? 'disabled' : ''} onclick="goPage(${page + 1})">Next ‚Üí</button>`;
    
    document.getElementById('pagination').innerHTML = html;
}

function goPage(p) {
    page = p;
    renderCards();
    window.scrollTo({ top: 300, behavior: 'smooth' });
}

let currentModalCard = null;

function openModal(idx) {
    const c = filteredCards[idx];
    if (!c) return;
    currentModalCard = c;
    
    document.getElementById('modalImg').src = c.image_url || (c.image_uris && c.image_uris.normal) || '';
    document.getElementById('modalName').textContent = c.name || c.card_name || 'Unknown';
    document.getElementById('modalSet').textContent = (c.set_name || c.set || '') + ' ‚Ä¢ ' + (c.rarity || '');
    document.getElementById('modalPrice').textContent = c.price ? '$' + parseFloat(c.price).toFixed(2) : 'Price not available';
    
    let details = '';
    if (c.condition) details += `<b>Condition:</b> ${c.condition}<br>`;
    if (c.seller_name) details += `<b>Seller:</b> ${c.seller_name}<br>`;
    if (c.type_line) details += `<b>Type:</b> ${c.type_line}<br>`;
    if (c.mana_cost) details += `<b>Mana Cost:</b> ${c.mana_cost}<br>`;
    if (c.oracle_text) details += `<b>Text:</b> ${c.oracle_text}<br>`;
    if (c.power && c.toughness) details += `<b>P/T:</b> ${c.power}/${c.toughness}<br>`;
    if (c.quantity && c.quantity > 1) details += `<b>Available:</b> ${c.quantity}<br>`;
    document.getElementById('modalDetails').innerHTML = details || 'No additional details';
    
    document.getElementById('cardModal').classList.add('show');
}

function addCurrentToCart() {
    if (currentModalCard && currentModalCard.id) {
        addToCart(currentModalCard.id);
    } else {
        alert('This card is not available for purchase');
    }
}

function closeModal() {
    document.getElementById('cardModal').classList.remove('show');
}

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
});

function toggleChat() {
    const chat = document.getElementById('devChat');
    chat.classList.toggle('collapsed');
    if (!chat.classList.contains('collapsed')) {
        loadChat();
        document.getElementById('chatInput').focus();
    }
}

let chatMessages = [];
const CHAT_USER = 'kevin';

async function loadChat() {
    try {
        const res = await fetch(`${API}/dev/messages`);
        chatMessages = await res.json();
        renderChat();
    } catch(e) {
        console.error('Chat load error:', e);
    }
}

function renderChat() {
    const body = document.getElementById('chatBody');
    body.innerHTML = chatMessages.map(m => `
        <div class="chat-msg">
            <div class="chat-author ${m.author}">${m.author.toUpperCase()} ${m.time || ''}</div>
            <div class="chat-text">${m.text}</div>
        </div>
    `).join('');
    body.scrollTop = body.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    
    try {
        await fetch(`${API}/dev/messages`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({author: CHAT_USER, text})
        });
        input.value = '';
        setTimeout(loadChat, 500);
    } catch(e) {
        console.error('Send error:', e);
    }
}

setInterval(loadChat, 3000);

init();
</script>

<div class="dev-chat collapsed" id="devChat">
    <div class="dev-chat-header" onclick="toggleChat()">
        <div class="dev-chat-title"><span class="dot"></span>Dev Squad Chat</div>
        <button class="dev-chat-toggle">‚ñº</button>
    </div>
    <div class="dev-chat-body" id="chatBody"></div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Message Jacques, Mendel, Clouse..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()" id="sendBtn">Send</button>
    </div>
</div>

</body>
</html>
