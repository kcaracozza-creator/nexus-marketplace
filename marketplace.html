<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Marketplace</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#0d0d12;color:#ddd;font-size:13px}
        header{background:#141419;padding:12px 20px;border-bottom:1px solid #c9a227;display:flex;align-items:center;justify-content:space-between}
        .logo{color:#c9a227;font-weight:700;font-size:18px;letter-spacing:1px}
        nav{display:flex;gap:20px;align-items:center}
        nav a{color:#888;text-decoration:none;font-size:12px;cursor:pointer}
        nav a:hover{color:#c9a227}
        .status{font-size:10px;padding:4px 10px;border-radius:10px}
        .status.on{background:#143d1f;color:#4a8}
        .status.off{background:#3d1414;color:#c44}
        .search-bar{background:#141419;padding:15px 20px;border-bottom:1px solid #252530;display:flex;gap:10px;align-items:center}
        .search-bar input{flex:1;padding:10px 15px;background:#1a1a22;border:1px solid #2a2a35;border-radius:4px;color:#ddd;font-size:13px}
        .search-bar input:focus{outline:none;border-color:#c9a227}
        .search-bar button{padding:10px 20px;background:#c9a227;border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer}
        .search-bar button:hover{background:#d4af37}
        .stats{display:flex;justify-content:center;gap:40px;padding:15px;background:#1a1a22;border-bottom:1px solid #252530}
        .stat-item{text-align:center}
        .stat-value{font-size:18px;font-weight:700;color:#c9a227}
        .stat-label{font-size:10px;color:#666;text-transform:uppercase}
        main{display:flex;min-height:calc(100vh - 180px)}
        .sidebar{width:200px;background:#141419;padding:15px;border-right:1px solid #252530}
        .filter-group{margin-bottom:20px}
        .filter-title{font-size:10px;color:#666;text-transform:uppercase;margin-bottom:8px;font-weight:600}
        .filter-group label{display:block;padding:4px 0;font-size:11px;cursor:pointer}
        .filter-group input[type=checkbox]{margin-right:6px;accent-color:#c9a227}
        .price-inputs{display:flex;gap:5px}
        .price-inputs input{width:50%;padding:6px;background:#1a1a22;border:1px solid #2a2a35;color:#ddd;border-radius:3px;font-size:11px}
        .clear-btn{width:100%;padding:8px;background:transparent;border:1px solid #2a2a35;color:#888;border-radius:3px;cursor:pointer;font-size:11px;margin-top:10px}
        .clear-btn:hover{border-color:#c9a227;color:#c9a227}
        .content{flex:1;padding:20px}
        .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .results-count{font-size:12px;color:#888}
        .results-count b{color:#c9a227}
        .sort-select{padding:6px 10px;background:#1a1a22;border:1px solid #2a2a35;color:#ddd;border-radius:3px;font-size:11px}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px}
        .card{background:#1a1a22;border:1px solid #252530;border-radius:6px;overflow:hidden;cursor:pointer;transition:all .2s}
        .card:hover{border-color:#c9a227;transform:translateY(-2px)}
        .card img{width:100%;aspect-ratio:0.72;object-fit:cover;background:#141419}
        .card-body{padding:12px}
        .card-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
        .card-set{font-size:10px;color:#666;margin-bottom:8px}
        .card-footer{display:flex;justify-content:space-between;align-items:center}
        .card-price{font-size:16px;font-weight:700;color:#c9a227}
        .card-rarity{font-size:9px;padding:2px 6px;border-radius:3px;text-transform:uppercase}
        .card-rarity.mythic{background:#8b4513;color:#ffa500}
        .card-rarity.rare{background:#1a1a4a;color:#ffd700}
        .card-rarity.uncommon{background:#1a3a1a;color:#c0c0c0}
        .card-rarity.common{background:#2a2a2a;color:#888}
        .pagination{display:flex;justify-content:center;gap:5px;margin-top:20px}
        .pagination button{padding:8px 12px;background:#1a1a22;border:1px solid #252530;color:#ddd;border-radius:3px;cursor:pointer;font-size:11px}
        .pagination button:hover{border-color:#c9a227}
        .pagination button.active{background:#c9a227;color:#000;border-color:#c9a227}
        .pagination button:disabled{opacity:.3;cursor:not-allowed}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center}
        .modal.show{display:flex}
        .modal-content{background:#141419;border:1px solid #252530;border-radius:8px;max-width:800px;width:95%;max-height:90vh;overflow:auto;display:flex}
        .modal-img{width:300px;flex-shrink:0;background:#0d0d12;display:flex;align-items:center;justify-content:center;padding:20px}
        .modal-img img{max-width:100%;max-height:400px;border-radius:8px}
        .modal-info{flex:1;padding:25px}
        .modal-name{font-size:22px;font-weight:700;margin-bottom:5px}
        .modal-set{font-size:13px;color:#666;margin-bottom:20px}
        .modal-price{font-size:32px;font-weight:700;color:#c9a227;margin-bottom:20px}
        .modal-details{font-size:12px;color:#888;line-height:1.8}
        .modal-details b{color:#ddd}
        .modal-close{position:absolute;top:15px;right:20px;background:none;border:none;color:#666;font-size:28px;cursor:pointer}
        .modal-close:hover{color:#ddd}
        .modal-actions{margin-top:20px;display:flex;gap:10px}
        .modal-actions button{padding:12px 25px;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px}
        .btn-primary{background:#c9a227;border:none;color:#000}
        .btn-secondary{background:transparent;border:1px solid #2a2a35;color:#ddd}
        .loading{text-align:center;padding:60px;color:#666}
        .spinner{width:30px;height:30px;border:3px solid #252530;border-top-color:#c9a227;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .error{background:rgba(200,60,60,.1);border:1px solid #c44;padding:20px;border-radius:6px;color:#c44;text-align:center}
        .empty{text-align:center;padding:60px;color:#666}
        .empty-icon{font-size:48px;margin-bottom:15px}

        /* DEV CHAT PANEL */
        .dev-chat{position:fixed;bottom:20px;right:20px;width:380px;background:#141419;border:1px solid #c9a227;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:999;display:flex;flex-direction:column;max-height:500px;transition:all .3s ease}
        .dev-chat.collapsed{max-height:48px;overflow:hidden}
        .dev-chat-header{padding:12px 16px;background:#1a1a22;border-bottom:1px solid #252530;border-radius:12px 12px 0 0;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
        .dev-chat-title{font-weight:700;font-size:13px;color:#c9a227;display:flex;align-items:center;gap:8px}
        .dev-chat-title .dot{width:8px;height:8px;background:#10b981;border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .dev-chat-toggle{background:none;border:none;color:#666;font-size:18px;cursor:pointer;transition:transform .3s}
        .dev-chat.collapsed .dev-chat-toggle{transform:rotate(180deg)}
        .dev-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;min-height:250px;max-height:350px}
        .chat-msg{display:flex;flex-direction:column;gap:4px}
        .chat-msg.user{align-items:flex-end}
        .chat-msg.ai{align-items:flex-start}
        .chat-author{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
        .chat-author.kevin{color:#c9a227}
        .chat-author.jacques{color:#7c5cff}
        .chat-author.mendel{color:#10b981}
        .chat-author.clouse{color:#3b82f6}
        .chat-bubble{max-width:85%;padding:10px 14px;border-radius:12px;font-size:12px;line-height:1.5}
        .chat-msg.user .chat-bubble{background:#c9a227;color:#000;border-bottom-right-radius:4px}
        .chat-msg.ai .chat-bubble{background:#1a1a22;border:1px solid #252530;border-bottom-left-radius:4px}
        .chat-msg.ai.jacques .chat-bubble{border-left:3px solid #7c5cff}
        .chat-msg.ai.mendel .chat-bubble{border-left:3px solid #10b981}
        .chat-msg.ai.clouse .chat-bubble{border-left:3px solid #3b82f6}
        .chat-time{font-size:9px;color:#666}
        .dev-chat-input{padding:12px 16px;border-top:1px solid #252530;display:flex;gap:8px}
        .dev-chat-input input{flex:1;padding:10px 14px;background:#1a1a22;border:1px solid #252530;border-radius:8px;color:#ddd;font-size:12px}
        .dev-chat-input input:focus{outline:none;border-color:#c9a227}
        .dev-chat-input button{padding:10px 16px;background:#c9a227;border:none;border-radius:8px;color:#000;font-weight:600;font-size:12px;cursor:pointer}
        .dev-chat-input button:hover{background:#d4af37}
        .dev-chat-input button:disabled{opacity:.5;cursor:not-allowed}
        .chat-hint{padding:8px 16px;background:#1a1a22;font-size:10px;color:#666;text-align:center}
        .chat-hint b{color:#888}
        @media(max-width:768px){.sidebar{display:none}.grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}.modal-content{flex-direction:column}.modal-img{width:100%;height:200px}.dev-chat{width:calc(100% - 20px);right:10px;bottom:10px}}
    </style>
</head>
<body>
<header>
    <div class="logo">NEXUS MARKETPLACE</div>
    <nav>
        <a href="#browse">Browse</a>
        <a href="#sell">Sell Cards</a>
        <a href="#orders">Orders</a>
        <a onclick="toggleChat()">Dev Chat</a>
        <span class="status off" id="serverStatus">‚óè Offline</span>
    </nav>
</header>
<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search cards by name..." onkeyup="if(event.key==='Enter')searchCards()">
    <button onclick="searchCards()">Search</button>
</div>
<div class="stats">
    <div class="stat-item"><div class="stat-value" id="totalCards">--</div><div class="stat-label">Cards Listed</div></div>
    <div class="stat-item"><div class="stat-value" id="totalValue">--</div><div class="stat-label">Total Value</div></div>
    <div class="stat-item"><div class="stat-value" id="uniqueSets">--</div><div class="stat-label">Sets</div></div>
</div>
<main>
    <aside class="sidebar">
        <div class="filter-group">
            <div class="filter-title">Price Range</div>
            <div class="price-inputs"><input type="number" id="priceMin" placeholder="Min"><input type="number" id="priceMax" placeholder="Max"></div>
        </div>
        <div class="filter-group">
            <div class="filter-title">Rarity</div>
            <label><input type="checkbox" value="mythic" onchange="applyFilters()"> Mythic Rare</label>
            <label><input type="checkbox" value="rare" onchange="applyFilters()"> Rare</label>
            <label><input type="checkbox" value="uncommon" onchange="applyFilters()"> Uncommon</label>
            <label><input type="checkbox" value="common" onchange="applyFilters()"> Common</label>
        </div>
        <div class="filter-group">
            <div class="filter-title">Color</div>
            <label><input type="checkbox" value="W" onchange="applyFilters()"> White</label>
            <label><input type="checkbox" value="U" onchange="applyFilters()"> Blue</label>
            <label><input type="checkbox" value="B" onchange="applyFilters()"> Black</label>
            <label><input type="checkbox" value="R" onchange="applyFilters()"> Red</label>
            <label><input type="checkbox" value="G" onchange="applyFilters()"> Green</label>
        </div>
        <button class="clear-btn" onclick="clearFilters()">Clear All Filters</button>
    </aside>
    <div class="content">
        <div class="results-header">
            <span class="results-count">Showing <b id="showCount">0</b> of <b id="totalCount">0</b> cards</span>
            <select class="sort-select" id="sortSelect" onchange="applyFilters()">
                <option value="name_asc">Name A-Z</option>
                <option value="name_desc">Name Z-A</option>
                <option value="price_desc">Price: High to Low</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="set">Set Name</option>
            </select>
        </div>
        <div id="cardGrid" class="grid"></div>
        <div id="pagination" class="pagination"></div>
    </div>
</main>

<!-- Card Detail Modal -->
<div class="modal" id="cardModal" onclick="if(event.target===this)closeModal()">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-img"><img id="modalImg" src=""></div>
        <div class="modal-info">
            <div class="modal-name" id="modalName"></div>
            <div class="modal-set" id="modalSet"></div>
            <div class="modal-price" id="modalPrice"></div>
            <div class="modal-details" id="modalDetails"></div>
            <div class="modal-actions">
                <button class="btn-primary">Add to Cart</button>
                <button class="btn-secondary">View on Scryfall</button>
            </div>
        </div>
    </div>
</div>

<!-- Dev Chat Panel -->
<div class="dev-chat" id="devChat">
    <div class="dev-chat-header" onclick="toggleChat()">
        <div class="dev-chat-title"><span class="dot"></span>Dev Squad Chat</div>
        <button class="dev-chat-toggle">‚ñº</button>
    </div>
    <div class="chat-hint">Mention <b>@jacques</b>, <b>@mendel</b>, or <b>@clouse</b> to summon an AI</div>
    <div class="dev-chat-messages" id="chatMessages"></div>
    <div class="dev-chat-input">
        <input type="text" id="chatInput" placeholder="Type a message..." onkeyup="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()" id="sendBtn">Send</button>
    </div>
</div>

<script>
const API = window.location.origin;
let allCards = [], filteredCards = [], page = 1, chatMessages = [];
const perPage = 48, CHAT_USER = 'Kevin';

async function init() {
    await checkServer();
    await loadCards();
    await loadChatMessages();
    setInterval(loadChatMessages, 3000);
}

async function checkServer() {
    const el = document.getElementById('serverStatus');
    try {
        const r = await fetch(API + '/health');
        if (r.ok) {
            el.className = 'status on'; el.textContent = '‚óè Online';
            const stats = await (await fetch(API + '/status')).json();
            document.getElementById('totalCards').textContent = (stats.cards_in_db || 0).toLocaleString();
            const analytics = await (await fetch(API + '/analytics/summary')).json();
            document.getElementById('totalValue').textContent = '$' + (analytics.total_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
        }
    } catch(e) { el.className = 'status off'; el.textContent = '‚óè Offline'; }
}

async function loadCards() {
    const grid = document.getElementById('cardGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading cards...</div>';
    try {
        const r = await fetch(API + '/cards/search?limit=1000');
        const data = await r.json();
        allCards = data.cards || data.results || [];
        document.getElementById('uniqueSets').textContent = new Set(allCards.map(c => c.set_name || c.set).filter(Boolean)).size;
        applyFilters();
    } catch(e) { grid.innerHTML = '<div class="error"><b>Cannot connect to server</b></div>'; }
}

function searchCards() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    filteredCards = q ? allCards.filter(c => (c.name || '').toLowerCase().includes(q)) : [...allCards];
    page = 1; renderCards();
}

function applyFilters() {
    let cards = [...allCards];
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (q) cards = cards.filter(c => (c.name || '').toLowerCase().includes(q));
    const minP = parseFloat(document.getElementById('priceMin').value) || 0;
    const maxP = parseFloat(document.getElementById('priceMax').value) || 999999;
    cards = cards.filter(c => { const p = parseFloat(c.price) || 0; return p >= minP && p <= maxP; });
    const rarities = [...document.querySelectorAll('.filter-group input[value="mythic"],.filter-group input[value="rare"],.filter-group input[value="uncommon"],.filter-group input[value="common"]')].filter(c => c.checked).map(c => c.value);
    if (rarities.length) cards = cards.filter(c => rarities.includes((c.rarity || '').toLowerCase()));
    const colors = [...document.querySelectorAll('.filter-group input[value="W"],.filter-group input[value="U"],.filter-group input[value="B"],.filter-group input[value="R"],.filter-group input[value="G"]')].filter(c => c.checked).map(c => c.value);
    if (colors.length) cards = cards.filter(c => colors.some(col => (c.colors || c.color_identity || []).includes(col)));
    const sort = document.getElementById('sortSelect').value;
    cards.sort((a, b) => {
        switch(sort) {
            case 'name_asc': return (a.name || '').localeCompare(b.name || '');
            case 'name_desc': return (b.name || '').localeCompare(a.name || '');
            case 'price_desc': return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
            case 'price_asc': return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
            default: return 0;
        }
    });
    filteredCards = cards; page = 1; renderCards();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('priceMin').value = '';
    document.getElementById('priceMax').value = '';
    document.getElementById('sortSelect').value = 'name_asc';
    document.querySelectorAll('.sidebar input[type=checkbox]').forEach(c => c.checked = false);
    filteredCards = [...allCards]; page = 1; renderCards();
}


function renderCards() {
    const grid = document.getElementById('cardGrid');
    const total = filteredCards.length;
    const start = (page - 1) * perPage;
    const pageCards = filteredCards.slice(start, start + perPage);
    document.getElementById('showCount').textContent = pageCards.length;
    document.getElementById('totalCount').textContent = total;
    if (!pageCards.length) {
        grid.innerHTML = '<div class="empty"><div class="empty-icon">üÉè</div>No cards found</div>';
        document.getElementById('pagination').innerHTML = ''; return;
    }
    grid.innerHTML = pageCards.map((c, i) => `
        <div class="card" onclick="openModal(${start + i})">
            ${c.image_url || (c.image_uris && c.image_uris.normal) ? 
                `<img src="${c.image_url || c.image_uris.normal}" loading="lazy" onerror="this.style.display='none'">` :
                `<div style="width:100%;aspect-ratio:.72;background:#141419;display:flex;align-items:center;justify-content:center;color:#444">No Image</div>`}
            <div class="card-body">
                <div class="card-name" title="${c.name || ''}">${c.name || 'Unknown'}</div>
                <div class="card-set">${c.set_name || c.set || ''}</div>
                <div class="card-footer">
                    <div class="card-price">${c.price ? '$' + parseFloat(c.price).toFixed(2) : '--'}</div>
                    <span class="card-rarity ${(c.rarity || '').toLowerCase()}">${c.rarity || ''}</span>
                </div>
            </div>
        </div>`).join('');
    renderPagination(total);
}

function renderPagination(total) {
    const pages = Math.ceil(total / perPage);
    if (pages <= 1) { document.getElementById('pagination').innerHTML = ''; return; }
    let html = `<button ${page === 1 ? 'disabled' : ''} onclick="goPage(${page - 1})">‚Üê Prev</button>`;
    for (let i = Math.max(1, page - 2); i <= Math.min(pages, page + 2); i++) html += `<button class="${i === page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
    html += `<button ${page === pages ? 'disabled' : ''} onclick="goPage(${page + 1})">Next ‚Üí</button>`;
    document.getElementById('pagination').innerHTML = html;
}

function goPage(p) { page = p; renderCards(); window.scrollTo({ top: 300, behavior: 'smooth' }); }

function openModal(idx) {
    const c = filteredCards[idx]; if (!c) return;
    document.getElementById('modalImg').src = c.image_url || (c.image_uris && c.image_uris.normal) || '';
    document.getElementById('modalName').textContent = c.name || 'Unknown';
    document.getElementById('modalSet').textContent = (c.set_name || c.set || '') + ' ‚Ä¢ ' + (c.rarity || '');
    document.getElementById('modalPrice').textContent = c.price ? '$' + parseFloat(c.price).toFixed(2) : 'N/A';
    let d = '';
    if (c.type_line) d += `<b>Type:</b> ${c.type_line}<br>`;
    if (c.mana_cost) d += `<b>Mana:</b> ${c.mana_cost}<br>`;
    if (c.oracle_text) d += `<b>Text:</b> ${c.oracle_text}<br>`;
    if (c.power && c.toughness) d += `<b>P/T:</b> ${c.power}/${c.toughness}<br>`;
    document.getElementById('modalDetails').innerHTML = d || 'No details';
    document.getElementById('cardModal').classList.add('show');
}
function closeModal() { document.getElementById('cardModal').classList.remove('show'); }

// DEV CHAT
function toggleChat() { document.getElementById('devChat').classList.toggle('collapsed'); }

async function loadChatMessages() {
    try {
        const r = await fetch(API + '/dev/messages');
        if (r.ok) { chatMessages = await r.json(); renderChatMessages(); }
    } catch(e) {}
}

function renderChatMessages() {
    const c = document.getElementById('chatMessages');
    if (!chatMessages.length) { c.innerHTML = `<div style="text-align:center;color:#666;padding:40px;font-size:11px">No messages yet.<br><br>Say hi!<br>Try: "hey @jacques what's up?"</div>`; return; }
    c.innerHTML = chatMessages.map(m => {
        const a = (m.author || '').toLowerCase();
        const isAI = ['jacques','mendel','clouse'].includes(a);
        return `<div class="chat-msg ${isAI ? 'ai ' + a : 'user'}"><span class="chat-author ${a}">${m.author}</span><div class="chat-bubble">${escapeHtml(m.text)}</div><span class="chat-time">${m.time || ''}</span></div>`;
    }).join('');
    c.scrollTop = c.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('chatInput'), btn = document.getElementById('sendBtn');
    const text = input.value.trim(); if (!text) return;
    input.disabled = btn.disabled = true; btn.textContent = '...';
    try {
        const r = await fetch(API + '/dev/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ author: CHAT_USER, text }) });
        if (r.ok) { input.value = ''; await loadChatMessages(); }
    } catch(e) {}
    input.disabled = btn.disabled = false; btn.textContent = 'Send'; input.focus();
}

function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
init();
</script>
</body>
</html>
